# Partial Embeddings Update
See details in [design doc](./../../design/partial_update/overview.md)

- [x] Add `Validity` field to all relations in the database

- [x] Get a list of files from the database, then scan in target directory, checking for changes in tracking hash.
  - Implementation note, new function [scan_for_change](./../../../crates/ploke-tui/src/app_state.rs) line 990
  - [x] return a list of changed files
    - Implementation note: takes `FileData`, returns `ChangedFileData` with new hash
- [x] Parse entire directory (same as plan 1)
- [/] Before transform into database, filter the `ParsedCodeGraph` for only those nodes/edges which are in the target files
  - Implementation Note: Kind of a hack job, needs more attention
- [/] Perform the same transform as in the full database transformation pipeline, using the filtered `ParsedCodeGraph`
  - [/] New nodes are inserted as usual, which means with `embedding: null`
- [/] Use cozo's `RETRACT` (see note) for any nodes in those files which still have embeddings, since they were not included in the parsed nodes.
  - [ ] Also retract all relations to/from the target files at the same time.
  - [/] Retract nodes in database which are not in filtered `ParsedCodeGraph`
    - [ ] Same approach for edges
  - No need to retract nodes that have changed, since the time travel approach takes care of this for us.
- [/] Same embeddings process, which queries the database for unembedded nodes.
