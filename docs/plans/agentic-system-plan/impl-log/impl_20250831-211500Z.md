# Impl Log — Message + Tool-Call Lifecycle Docs and E2E harness

Summary
- Added a comprehensive workflow doc describing the message and tool-calling lifecycle with indexed workspace, external file changes, LLM requests, tool call dispatch, safe-edit pipeline, persistence, restart, and load.
- Established an end-to-end test harness flow that exercises tool calls (splice path) and prepared a canonical-path E2E (temporarily ignored pending DB rule fix).

Changes
- Docs:
  - Added `crates/ploke-tui/docs/workflows/message_and_tool_call_lifecycle.md`.
- Tests:
  - Added `crates/ploke-tui/tests/e2e_tool_calls.rs` with two scenarios:
    - `e2e_get_file_metadata_and_apply_code_edit_splice` (passes): stages metadata and splice edit, approves, verifies updated file.
    - `e2e_apply_code_edit_canonical_on_fixture` (ignored): demonstrates canonical path edit on `fixture_nodes`, currently blocked by a Cozo rule requiring `file_hash` binding; includes workspace reindex step.
- LLM/tool migration earlier in the session:
  - Switched to `openrouter::model_provider::CompReq` for requests.
  - Tool-call parsing uses `tools::ToolCall<'a>`; dispatcher uses GAT-based tools.

Evidence
- `cargo test -p ploke-tui --features test_harness`: 61 passed; 0 failed; 4 ignored.
- Splice E2E validates ToolCallCompleted events and successful IoManager apply.

Rationale
- The doc and tests provide an anchor for future contributors to reason about message/event flow and safely evolve the tool-calling system without regressions.

Next Steps
- Un-ignore canonical edit E2E once the DB rule (`file_hash` binding) is fixed or a pre-indexed fixture is restored reliably.
- Add streaming tool-call handling (delta path) in `RequestSession::run`.
- Expand live API tests (gated) to verify full loop (request → tool_calls → applied edits) with persisted artifacts under `ai_temp_data`.

References
- `crates/ploke-tui/docs/workflows/message_and_tool_call_lifecycle.md`
- `crates/ploke-tui/src/llm/session.rs`, `crates/ploke-tui/src/tools/mod.rs`, `crates/ploke-tui/src/rag/tools.rs`, `crates/ploke-tui/src/rag/editing.rs`
  
