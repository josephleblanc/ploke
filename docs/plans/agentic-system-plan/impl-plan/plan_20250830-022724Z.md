# Plan: Generalize and Strengthen json_visitor for OpenRouter Responses

Links:
- Assessment: `docs/reports/json_visitor_assessment_20250830-022724Z.md`
- Source: `crates/ploke-tui/src/llm/openrouter/json_visitor.rs`
- Test output: `crates/ploke-tui/data/models/all_raw_stats.txt`

## Objectives and Scope
- Generalize the visitor to profile arbitrary OpenRouter responses (not just models) and guide strong-typing design.
- Provide accurate per-model presence/null/missing counts, type histograms, array element typing, and value distributions.
- Offer actionable enum and struct suggestions, mixed-type detection, and numeric-like string detection.
- Improve report clarity and add a JSON artifact suitable for tooling.
- Keep memory usage bounded via configurable caps.

Out of scope:
- CLI surface and config via flags (future). We add an internal Config struct only.
- Code generation of types (future). This plan focuses on analysis artifacts.

## Proposed Steps with Rationale and Acceptance Criteria

1) Unify traversal and per-model accounting
- Rationale: Current counts overcount inside arrays and can’t compute missing/nonnull correctly.
- Changes:
  - Introduce `StatsBuilder` capturing per-model `seen_paths` to ensure 0/1 presence per model.
  - Record `presence`, `null`, and compute `missing = total_models - presence` per path.
- Acceptance:
  - Report shows presence%, null%, missing% for top-level and nested fields.

2) Add type histograms and numeric ranges
- Rationale: Strong typing depends on consistent types and ranges.
- Changes:
  - Track counts for Null/Bool/Int/Float/String/Object/Array per path.
  - For numbers: track min/max and int vs float counts.
- Acceptance:
  - Report includes a section “Type distributions” and “Numeric ranges (min..max)” where applicable.

3) Generalize arrays: element typing, unions, and frequencies
- Rationale: Arrays drive enum and struct design.
- Changes:
  - For arrays, track length distributions, element-type histograms.
  - For arrays-of-strings: union and frequency (top-K), enum recommendation.
  - For arrays-of-objects: union of keys; presence% per element-key.
- Acceptance:
  - Report shows generalized unions; `supported_parameters` is no longer special-cased yet remains visible.

4) Value distributions and enum recommendations
- Rationale: Need frequency + cardinality thresholds.
- Changes:
  - Track per-field value frequencies (cap via top-K); record total cardinality.
  - Heuristics: enum-candidate when cardinality ≤ `enum_max` OR ratio ≤ `enum_ratio_max` and no numeric only.
- Acceptance:
  - Report lists candidates with counts; shows cardinality and share.

5) Numeric-like string and coercion detection
- Rationale: Avoid “stringly-typed” plumbing; catch fields that should be numeric.
- Changes:
  - Detect numeric-like strings; flag fields mixing string and numeric; recommend parsing strategy.
- Acceptance:
  - Report section “Potential coercions” flags fields and suggests `f64`, `i64`, or custom deserializers.

6) Output clarity and JSON artifact
- Rationale: Machine-readable stats enable tool-driven decisions.
- Changes:
  - Reorder sections, sort deterministically, add clear headings and percentages.
  - Emit JSON stats to `crates/ploke-tui/data/models/all_raw_stats.json` (and keep the `.txt`).
- Acceptance:
  - File is created with structured data; text remains readable and stable.

7) Efficiency and configurability
- Rationale: Prevent memory blowups.
- Changes:
  - Add `Config { top_k_values, max_union, enum_max, enum_ratio_max }` and caps on tracked values.
- Acceptance:
  - Code compiles with a default config; large value sets are summarized with overflow notes.

## Deliverables
- Updated `json_visitor.rs` implementing steps above.
- Text report (existing path) + JSON report (`all_raw_stats.json`).
- Iteration logs:
  - `docs/plans/agentic-system-plan/impl-plan/impl_20250830-022724Z_iter1.md`
  - `docs/plans/agentic-system-plan/impl-plan/impl_20250830-022724Z_iter2.md`
  - `docs/plans/agentic-system-plan/impl-plan/impl_20250830-022724Z_iter3.md`

## Validation Approach
- Run the existing test to regenerate reports; include brief pass/fail summary.
- Manually inspect the `.txt` report for new sections and stable ordering.
- Sanity-check JSON report shape and key metrics.
- Evidence artifacts (paths):
  - `crates/ploke-tui/data/models/all_raw_stats.txt`
  - `crates/ploke-tui/data/models/all_raw_stats.json`

## Acceptance Criteria (summarized)
- Presence/null/missing percentages per field.
- Type histograms and numeric min/max.
- Array element typing and unions; `supported_parameters` covered via generalized logic.
- Candidate enums listed with frequencies and cardinality.
- Potential coercions flagged.
- JSON stats emitted alongside text report.
- Config values present and used to cap memory.

## Notes and Open Questions
- For nested arrays/objects, presence% is defined over top-level `data` items. For fields inside arrays, we will attribute presence when at least one element contributes that path in a model (documented behavior).
- If other endpoints have different top-level structures, we can parameterize the root array key (default: `data`).

