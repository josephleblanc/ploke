# Impl Log â€” Canonical request_code_context schema + GAT dispatch

Plan reference: docs/plans/agentic-system-plan/impl-plan/plan_20250831-121500Z.md

Summary
- Adopted canonical input schema for `request_code_context`: `{ token_budget: u32, hint?: string }`.
- Unified the dispatcher to use GAT-based tool implementations via `tools::dispatch_gat_tool` for all tools.
- Removed an unreachable `panic!()` in `llm/session.rs` and made the non-streaming choice path compile.
- Added live endpoint test scaffold (gated by `live_api_tests` + `test_harness`) persisting request/response under `ai_temp_data/live/`.

Changes
- tools/request_code_context.rs:
  - Updated Tool and GAT params to `{ token_budget, hint }`.
  - GAT::execute returns `RequestCodeContextResult` JSON (ok, query, top_k, context).
  - Schema updated accordingly; tests adjusted.
- tools/mod.rs:
  - Added `dispatch_gat_tool` to route legacy `ToolCallParams` to GAT tools.
  - Fallback to legacy `rag::tools::apply_code_edit_tool` for splice-style payloads when GAT canonical parse fails.
  - Added unit tests earlier; retained.
- rag/dispatcher.rs:
  - Switched to `tools::dispatch_gat_tool` for all tools.
- tools/code_edit.rs:
  - GAT now uses the inbound `request_id`/`call_id` from `Ctx` (fixes proposal registry lookups).
- llm/mod.rs & llm/session.rs:
  - Continued migration to strong `tools::ToolDefinition`.
  - Removed `panic!()`; minimal loop path compiles.
- tests/live_openrouter_tools.rs:
  - New gated test building a typed tool request and persisting request/response JSON under `ai_temp_data/live/openrouter-<ts>/`.

Evidence
- Command: `cargo test -p ploke-tui`
- Result: All tests passing locally (unit + integration). Live tests are gated and not executed by default.

Notes & Risks
- Live tool-call parsing in `llm/session.rs` remains incomplete. The test only checks HTTP 200 and presence of tool-related markers, and saves artifacts for manual inspection.
- Next step is to fully implement parsing of tool_calls for OpenRouter shape (function { name, arguments }) and drive the tool-call cycle.

Next
- Implement robust tool_calls parsing + execution loop in `RequestSession::run` using `LlmTool` trait flow.
- Validate response shapes against `crates/ploke-tui/docs/openrouter/request_structure.md` and update types/enums accordingly.
- Expand live tests to assert deserialization coverage and absence of unexpected fields.
