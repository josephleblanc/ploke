# Detailed Plan: Phase 1 UX + Persistence + Observability

Status Context
- Typed `apply_code_edit` request implemented with tagged enum and legacy shim.
- All three proposal flow tests pass; evidence logged.
- This plan expands the next steps with concrete tasks, acceptance criteria, and tests.

Objectives (Phase 1 Slice)
- Approvals overlay UI to inspect and act on staged proposals.
- Proposal persistence (disk; optional DB observability hooks).
- Post-apply rescan trigger to keep indexes fresh.
- Open-in-editor convenience via `$PLOKE_EDITOR` with config override.
- Per-request outcome summaries in LLM session.
- Tightened tests using `fixture_nodes` crate + its backup DB for realistic validation.

Non‑negotiable Principles
- Strong typing for all tool args/results and internal state (see AGENTS.md).
- Make invalid states unrepresentable; no stringly tool schemas.
- Safety-first editing via IoManager with hash validation.

Tasks and Steps

1) Approvals Overlay UI
- Files:
  - `crates/ploke-tui/src/app/view/components/approvals.rs` (new)
  - `crates/ploke-tui/src/app/view/components/mod.rs` (re-export)
  - `crates/ploke-tui/src/app/input/keymap.rs` (add actions)
  - `crates/ploke-tui/src/app/mod.rs` (wire overlay, input handling, render)
- Features:
  - List `AppState.proposals` with: short `request_id`, status, count of files, age.
  - Detail pane for selected proposal:
    - If `DiffPreview::UnifiedDiff`, render truncated unified diff.
    - If `DiffPreview::CodeBlocks`, render before/after for current file selection with truncation.
  - Actions:
    - Approve: `Enter` or `y` → send `StateCommand::ApproveEdits { request_id }`.
    - Deny: `n` or `d` → send `StateCommand::DenyEdits { request_id }`.
    - Open-in-editor: `o` → spawn editor on first file (line optional; see below).
    - Close overlay: `q`/`Esc`.
  - Navigation: `j/k` or arrows to move; page up/down.
- Acceptance Criteria:
  - Overlay toggles on/off (keybinding e.g., `A`).
  - Lists real proposals and reflects status changes after approve/deny.
  - Renders preview without panics for both diff and codeblock modes.
  - No flicker/regressions in main TUI loop.
- Tests:
  - Ratatui buffer snapshot tests: empty list, single proposal, multiple proposals; selection changes. Ensure snapshots are stable and readable.
  - Key handling unit tests for overlay actions.

2) Proposal Persistence (Disk; optional DB)
- Files:
  - `crates/ploke-tui/src/app_state/core.rs` (serde representations or mirror types)
  - `crates/ploke-tui/src/app_state/handlers/session.rs` (save/load helpers)
  - `crates/ploke-tui/src/user_config.rs` (path in config: default `~/.config/ploke/proposals.json`)
- Behavior:
  - On proposal map changes, schedule debounce save to disk (JSON; typed schema).
  - On startup, load proposals and rehydrate into memory (only Pending/Denied/Applied as appropriate; ignore malformed with warning).
  - Optional: behind feature flag or minimal trait to persist to DB via `ploke_db::observability` when APIs are ready.
- Acceptance Criteria:
  - Proposals survive restart; statuses preserved.
  - Corruption or missing file yields graceful warnings; no crash.
- Tests:
  - Write/read roundtrip for sample proposals; partial corruption handling.

3) Post‑Apply Rescan and Index Refresh
- Files:
  - `crates/ploke-tui/src/rag/editing.rs` (after success, send `StateCommand::ScanForChange { scan_tx }` for affected files or crate)
  - `crates/ploke-tui/src/app_state/dispatcher.rs` (reuse existing handler)
- Behavior:
  - After approve, trigger scan; surface SysInfo summary: files rescanned and any issues.
- Acceptance Criteria:
  - Rescan is invoked; no deadlocks; UI shows summary.
- Tests:
  - Integration test: approve path triggers scan command (mock channel or assert SysInfo containing marker).

4) Open‑in‑Editor Convenience
- Files:
  - `crates/ploke-tui/src/user_config.rs` (editor command setting)
  - `crates/ploke-tui/src/app/view/components/approvals.rs` (bind `o` to spawn)
- Behavior:
  - Editor command precedence: config value (optional) → `$PLOKE_EDITOR` → None (no-op with SysInfo guidance). Do not use `$EDITOR`.
  - Build command as `cmd {path}:{line}` when line is available (canonical edits); for non-canonical or unknown line use `cmd {path}`.
  - Show SysInfo on success/failure; do not block UI.
- Acceptance Criteria:
  - Command executes on supported systems; errors are handled.
- Tests:
  - Unit test for command construction precedence and formatting.
  - Attempt up to three approaches to verify spawn in CI/dev (e.g., mockable command runner, using a harmless echo command, or dev-only helper crate). If all three fail, abort and record a report detailing attempts and outcomes; annotate tests with notes on any added dev dependencies or platform caveats.

5) Per‑Request Outcome Summaries (LLM)
- Files:
  - `crates/ploke-tui/src/llm/session.rs` (accumulate tool outcomes per request)
  - `crates/ploke-tui/src/llm/mod.rs` (types if necessary)
- Behavior:
  - Emit concise SysInfo after a request completes: `success`, `no_tool_calls`, `404`, `429` counts.
  - Persist summary to compact trace index (future step) and show in session trace overlay later.
- Acceptance Criteria:
  - SysInfo messages appear deterministically; do not duplicate across retries.
- Tests:
  - Unit test: simulated tool events → computed summary string.

6) Tests Using `fixture_nodes` + Backup DB (Tightened Realism)
- Files:
  - `crates/ploke-tui/tests/overlay_and_persistence.rs` (new)
  - Existing live/real tools tests reference: `crates/ploke-tui/src/app/commands/exec_real_tools_live_test.rs`
- Behavior:
  - Use `tests/fixture_crates/fixture_nodes` as the target; if tests mutate it, restore from `tests/fixture_crates/fixture_nodes_copy` on panic/teardown.
  - Load and use the backup parsed+embedded DB at `tests/backup_dbs/fixture_nodes_bfc25988-15c1-5e58-9aa8-3d33b5e58b92` for realistic spans and hashes.
  - Verify canonical edit flows against well-known items in this fixture (fields and NodeId v5 UUIDs are validated extensively in syn_parser).
- Acceptance Criteria:
  - Overlay renders and actions behave over the real fixture; proposals apply correctly; post-apply rescan emits expected SysInfo.
- Tests:
  - Integration tests that open overlay, approve/deny on staged canonical edits referencing known nodes; ensure DB-backed spans align and writes succeed.

7) Typed Serde Tests for Code Edit Tool
- Files:
  - `crates/ploke-tui/tests/serde_apply_code_edit.rs` (new)
- Behavior:
  - Roundtrip for `ApplyCodeEditRequest` with both `Canonical` and `Splice`.
  - Legacy payload deserializes via shim and equals expected typed form.
- Acceptance Criteria:
  - Tests pass; no lossy fields. Prefer Canonical edit tests; legacy splice shim covered minimally and scheduled for removal.

8) Documentation and Reflections
- Update `docs/reports/design_reflections_20250826-204758Z.md` with:
  - Rationale for overlay structure, persistence tradeoffs, editor command approach.
  - Future Phase 2 hooks (agent orchestrator integration points).
- Link this plan from `AGENTIC_SYSTEM_PLAN.md` and onboarding if needed.

Out of Scope (defer to subsequent iteration)
- Git branch apply/revert using `gix` (placeholder action may be stubbed now).
- Session Trace overlay (separate dedicated plan).
- DB observability tables for proposals/apply results (wire when APIs are finalized).
- Removal of legacy splice mode in handler (plan below).

Deprecation Plan: Phase out Splice
- Short term (this slice): Prefer Canonical edits in all new tests and examples; keep the migration shim only to support existing tests until Canonical coverage fully replaces them.
- Next slice:
  - Convert remaining tests to Canonical mode using `fixture_nodes` + backup DB.
  - Emit deprecation warnings on Splice usage and document removal timeline.
  - Remove shim and reject Splice payloads in handler once Canonical tests cover all scenarios.

Risks and Mitigations
- UI complexity: keep a simple list + details pane; snapshot tests.
- Persistence churn: debounce writes; scoped locking on proposals map.
- Editor command portability: make command configurable; no hard dependency.

Validation Checklist
- All overlay interactions snapshot-tested; proposal flow tests remain green.
- Disk persistence roundtrip verified.
- Approve triggers rescan; SysInfo summaries emitted.
- Serde tests cover both edit modes + legacy shim.
