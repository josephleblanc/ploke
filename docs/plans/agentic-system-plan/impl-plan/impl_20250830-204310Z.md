# Impl Log — OpenRouter Model Provider (Phase 2)

Plan: docs/plans/agentic-system-plan/impl-plan/plan_20250830-064828Z.md
Scope: Continue provider endpoints typing + request struct work; keep edits minimal and strongly typed per AGENTS.md.

What I changed
- Fixed and completed `crates/ploke-tui/src/llm/openrouter/model_provider.rs`:
  - Removed malformed/duplicate code and corrected imports.
  - Added strongly typed markers:
    - `JsonObjMarker` → serializes/deserializes to `{ "type": "json_object" }`.
    - `FallbackMarker` → serializes/deserializes to `"fallback"`.
  - Implemented `ToolChoice` with manual serde to match: `none | auto | { type: "function", function: { name } }` using `tools::FunctionMarker`.
  - Introduced typed wrappers: `ModelIdRaw`, `CanonicalSlug`→`ProvEnd` (Arc<str>), `ProviderSlug`, and `ProviderNameStr::normalized_slug()`.
  - Defined typed `Endpoint` for `/models/:author/:model/endpoints` entries using shared `ModelPricing`, `ModelCapabilitiesRaw`, and `SupportedParameters`.
  - `CompReq` now references `llm::RequestMessage` and `tools::ToolDefinition` consistently.
- Updated `ProvEnd` in `provider_endpoints.rs` to hold `Arc<str>` for `author` and `model`; added serde + `TryFrom<&Url>`; updated tests accordingly.

New tests
- `model_provider.rs` (unit):
  - `json_obj_marker_serde_roundtrip` (pass)
  - `fallback_marker_serde_roundtrip` (pass)
  - `tool_choice_serde_variants` (pass)
  - `provider_name_str_slug_and_author` (pass)
  - `endpoint_min_deserialize` (pass)
- `provider_endpoints.rs` (existing):
  - `prov_end_from_canonical_slug` passes with new `ProvEnd` shape (Arc<str>).
- Live (gated by `--features live_api_tests`):
  - `live_endpoints_fetch_smoke` hits `/models/:author/:model/endpoints` for a common model; requires `OPENROUTER_API_KEY`.

Results (offline)
- Workspace `cargo test`: all new unit tests pass.
- Two unrelated observability integration tests in `ploke-tui/tests/observability_lifecycle.rs` fail (Cozo parser message). These are outside current scope and untouched.

How to run live test
- Command (single test):
  - `cargo test -p ploke-tui --lib --features live_api_tests live_endpoints_fetch_smoke`
- Requires network + `OPENROUTER_API_KEY` (dotenv supported via `test_harness::openrouter_env`).

Next steps
- Optionally run the live test (with approval) to validate endpoint shape against the real API.
- Add fixture-backed tests for full Endpoint arrays and provider alias handling.
- Integrate Endpoint + ToolChoice into routing/model browser.
