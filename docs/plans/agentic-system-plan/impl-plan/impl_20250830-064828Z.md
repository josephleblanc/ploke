# Implementation Log — Steps 1–2

Plan: docs/plans/agentic-system-plan/impl-plan/plan_20250830-064828Z.md

Summary
- Unified pricing: deprecated alias `provider_endpoints::Pricing` -> canonical `openrouter_catalog::ModelPricing` with `Default` and getters.
- Strong `canonical_slug` typing: `ModelEndpoint.canonical: Option<ProvEnd>` with custom serde; `ProvEnd { author: Arc<str>, model: Arc<str> }` and TryFrom<Url>.
- Endpoint ops: `ProvEnd::call_endpoint()` and `persist_resp_raw()` implemented; writes JSON under `crates/ploke-tui/data/endpoints/{author}/{model}-{ts}.json`.
- Tests:
  - Adjusted exec.rs typed-response unit to keep passing via optional `canonical`.
  - Added live-gated tests in provider_endpoints.rs:
    - `test_call_known_model` (200 + data present)
    - `test_persist_resp_raw_creates_file` (file created)
  - Gated flakey/live tests in `models.rs` under `feature = "live_api_tests"`; adapted supported_parameters test to enum values.

Rationale/Notes
- Chose `Arc<str>` for ProvEnd.author instead of the providers `Author` enum. OpenRouter’s URL author segment (e.g., "qwen") is not a closed set and does not align with provider slugs; enforcing the provider enum caused deserialization failures for real endpoints.
- Kept ModelEndpoint.pricing via alias to preserve call sites; deprecates only, no removals.
- Fixed URL join semantics; now builds `models/{author}/{model}/endpoints` in one join to avoid dropping the model segment.

Evidence
- Fast suite: cargo test (no features)
  - Pass summary: majority green
  - Two unrelated failures in `tests/observability_lifecycle.rs`: Cozo query parse errors (unchanged by this work)
- Live-gated tests (using .env OPENROUTER_API_KEY):
  - `provider_endpoints::tests::test_call_known_model` → PASS
  - `provider_endpoints::tests::test_persist_resp_raw_creates_file` → PASS

Commands
- Full: `cargo test`
- Live-only (targeted):
  - `cargo test -p ploke-tui provider_endpoints::tests::test_call_known_model --features live_api_tests`
  - `cargo test -p ploke-tui provider_endpoints::tests::test_persist_resp_raw_creates_file --features live_api_tests`

Open Items
- Observability tests failing in `tests/observability_lifecycle.rs` (DB query parser); appears unrelated; deferring.
- Next: Integrate capabilities cache into Model Browser Phase 2.1 (list/search/set-active) per plan.
