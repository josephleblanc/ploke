# Plan: Phase 1 Minimal Slice — Approvals Overlay, Agent Orchestrator Seed, Provider Allowlist, Outcome Summaries

Objectives and Scope
- Deliver an end-to-end minimal agentic slice that safely stages code edits, provides a first-class approvals UI, emits per-request outcomes, and adds a basic planner loop bound to the current chat.
- Keep scope within in-process TUI + tool-calling context; no new services. Defer full CI/build gates and MCP extraction to later phases.

Non‑Negotiable Principles (from AGENTS.md)
- Strong typing for all OpenRouter-touching code and tool schemas (serde derives; numeric fields as numeric types). Prefer enums/tagged unions; avoid stringly typed detection. Use #[serde(untagged)] only as a migration bridge with deprecation warnings.
- Safety-first editing: Stage edits with verified file hashes, apply atomically via IoManager, never write on hash mismatch. Keep destructive ops behind explicit approvals.
- Evidence-based changes: Run targeted and full tests; store evidence under `docs/plans/agent-system-plan/testing/`. Update design/reflection docs for notable trade-offs.

Proposed Steps, Rationale, and Acceptance Criteria

1) Approvals Overlay (browse/approve/deny staged proposals)
- Rationale: Make edit staging visible and actionable; reduce friction and errors.
- Changes:
  - Add `crates/ploke-tui/src/app/view/components/approvals.rs` (overlay list + detail pane).
  - Wire into `app/mod.rs` with keybindings: open `e`, approve `Enter`/`y`, deny `n`/`d`, open-in-editor `o`, navigate `j/k`/arrows, close `q`/`Esc`.
  - Render both preview modes (unified diff, code blocks) safely with truncation.
- Acceptance:
  - Overlay toggles on/off; lists real proposals; approve/deny updates status; no UI panics/flicker.
  - Ratatui snapshot tests cover empty/single/multiple cases and key events.

2) Provider Allowlist and Tool-Capability UX
- Rationale: Improve tool-call reliability across OpenRouter providers; give users control and clear feedback.
- Changes:
  - Extend `user_config::ModelRegistry` to support provider allowlist/pinning for tools.
  - Surface a “tools-capable” badge and allowlist info in model browser; enforce when `require_tool_support` is set.
- Acceptance:
  - Switching provider updates active model; allowlist respected; badge visible. Unit tests for selection logic.

3) Per-Request Outcome Summaries
- Rationale: Provide concise feedback on tool-call sessions (success/no tools/404/429) to improve debuggability.
- Changes:
  - In `llm/session.rs`, accumulate tool outcomes; emit a SysInfo summary at the end of each request.
- Acceptance:
  - Deterministic, single summary per request; unit test simulating event sequences.

4) Minimal Agent Orchestrator (Planner + Critic seed)
- Rationale: Introduce a light, in-process loop to chain `request_code_context` → optional `get_file_metadata` → `apply_code_edit` (staged) with clear handoff to approvals.
- Changes:
  - New module `crates/ploke-tui/src/agent/` with `mod.rs`, `planner.rs`, `critic.rs`, `policy.rs`.
  - Commands: `/agent on|off`, `/agent plan`, `/agent apply` in TUI input path.
  - Session memory keyed by conversation id to avoid redundant tool attempts.
- Acceptance:
  - `/agent plan` runs a single-cycle plan and stages edits when appropriate; errors are surfaced with actionable guidance. Unit tests for planner policy and state transitions.

5) Post-Apply Rescan Hook
- Rationale: Reduce drift after approvals; keep DB and indexes fresh.
- Changes:
  - After successful approve, send `StateCommand::ScanForChange { .. }` for affected files or crate; show SysInfo summary.
- Acceptance:
  - Rescan invoked reliably; summary emitted; integration test asserts the command is sent.

Deliverables
- New overlay component and TUI wiring.
- Provider allowlist configuration and UX.
- Outcome summaries emitted from LLM session.
- Minimal agent orchestrator module with basic commands.
- Post-apply rescan integration.

Validation Approach
- Tests:
  - UI snapshot tests for approvals overlay interactions.
  - Model provider selection logic tests.
  - LLM session outcome summary unit test.
  - Planner policy/state transition unit tests.
  - Integration for post-apply rescan trigger.
- Evidence:
  - Store `cargo test` outputs under `docs/plans/agent-system-plan/testing/` with timestamped filenames.
  - If any test is flaky or blocked by environment, record findings and mitigation notes in the corresponding `impl_*.md`.

References
- AGENTIC_SYSTEM_PLAN.md (survey, next-steps, safety policy)
- docs/plans/agentic-system-plan/README_NEXT_ASSISTANT.md (onboarding, test/evidence locations)
- docs/reports/affected_code_paths_20250826-204758Z.md (guides to impacted files/flows)
- docs/testing/TEST_GUIDELINES.md (UI snapshots, benchmarks, stopping points)
- docs/reports/design_reflections_20250826-204758Z.md (rationale and trade-offs)
- docs/reports/code_edit_tool_schema_assessment_20250827-043300Z.md (typed tool schema)

Linkage and Logs
- Implementation logs will be added under `docs/plans/agentic-system-plan/impl-log/` as `impl_*.md` and will link back to this plan file: `docs/plans/agentic-system-plan/impl-plan/plan_20250827-080159Z.md`.

Progress Status
- Pre-implementation setup complete:
  - Gated long-running/live tests behind env vars (`PLOKE_RUN_LIVE_TESTS`, `PLOKE_RUN_EXEC_LIVE_TESTS`, `PLOKE_RUN_EXEC_REAL_TOOLS_LIVE_TESTS`, `PLOKE_RUN_UPDATE_EMBED`).
  - Updated testing docs to prefer brief inline summaries over file-based logs by default.
- Current test baseline (offline): mostly green; one failing unit test in `ploke-rag` (`core::unit_tests::tests::test_search_traits`), unrelated to this plan’s scope.
- Next: implement Step 1 (Approvals Overlay) per this plan.
