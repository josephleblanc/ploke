# Plan: Phase 1 â€” Approvals Overlay, Typed Code Edit Tool, Tests

Objectives
- Fix failing proposal flow tests by handling a strongly-typed direct splice mode for `apply_code_edit`.
- Preserve canonical edit mode via typed DB resolution.
- Scaffold Approvals overlay for listing/approving/denying proposals.
- Record test evidence under testing logs.

Principles
- Strong typing for all tool args/results; no stringly detection. Make invalid states unrepresentable.
- Safety-first editing with hash verification via IoManager.
- Evidence-based progress with recorded test runs.

Steps
1) Typed request/response for `apply_code_edit`
   - Define `ApplyCodeEditRequest { edits: Vec<Edit>, confidence: Option<f32> }` with `Edit::{Canonical, Splice}` (tagged enum).
   - Implement handler to match on variants and build `WriteSnippetData`.
   - During migration, accept legacy direct splice shape via a dedicated `#[serde(untagged)]` shim enum that maps into `Edit::Splice` with a deprecation log.
   - Acceptance: `m1_edit_proposal_flows` tests pass; serde round-trip tests for request/response.

2) Staging and approvals flow sanity
   - Ensure proposal registry is populated with Pending status and preview.
   - Verify approve/deny transitions update status and bridge tool events.
   - Acceptance: existing approve/deny tests pass; file content updated only on approval.

3) Approvals overlay (skeleton)
   - Add `app/view/components/approvals.rs` and wire into `app/mod.rs`.
   - Navigate proposals; trigger approve/deny via commands.
   - Acceptance: overlay opens and lists proposals; basic keybindings functional (no persistence yet).

4) Evidence and docs
   - Run `cargo test` full suite and targeted tests; store logs in `docs/plans/agent-system-plan/testing/`.
   - Update AGENTIC_SYSTEM_PLAN.md with Type Safety Policy and link the schema assessment report.
   - Add AGENTS.md with the plan-review-implement workflow.

Deliverables
- Typed tool request/response, passing tests, overlay skeleton, updated docs and test logs.

Validation
- Targeted: `crates/ploke-tui/tests/m1_edit_proposal_flows.rs` (3 tests) pass locally.
- Full suite: matches prior run (per `README_NEXT_ASSISTANT.md`).

References
- docs/reports/code_edit_tool_schema_assessment_20250827-043300Z.md
- AGENTIC_SYSTEM_PLAN.md (Type Safety Policy)
- docs/testing/TEST_GUIDELINES.md

