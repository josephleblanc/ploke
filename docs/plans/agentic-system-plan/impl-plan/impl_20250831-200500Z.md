# Impl Log â€” Migrate to tools::ToolDefinition (GAT groundwork)

Plan reference: docs/plans/agentic-system-plan/impl-plan/plan_20250831-121500Z.md

Summary
- Replaced deprecated llm::ToolDefinition/ToolFunctionDef usages with strongly typed `tools::ToolDefinition` and `tools::ToolFunctionDef`.
- Updated request construction to carry typed tool defs end-to-end.
- Preserved existing request parameter shapes for compatibility with current dispatcher:
  - `request_code_context`: `{ token_budget, hint }` (matches `rag::handle_request_context`).
  - `apply_code_edit`: legacy splice payload (accepted via `LegacyApplyDirect` fallback).
- Adjusted tests to assert structure rather than brittle pretty-printed snapshots.

Changes
- llm/mod.rs:
  - `OpenAiRequest.tools: Option<Vec<tools::ToolDefinition>>`.
  - Rewrote `get_file_metadata_tool_def`, `request_code_context_tool_def`, `apply_code_edit_tool_def` to return `tools::ToolDefinition` with typed names/descriptions, keeping legacy parameter JSON.
  - Tool name logging now uses `ToolName::as_str()`.
- llm/session.rs:
  - Adopted `crate::tools::ToolDefinition` throughout (builder and logs).
  - Revised `test_build_request_tool_call_snapshot` to build a real, typed tool def and assert key fields.

Evidence
- Command: `cargo test -p ploke-tui`
- Result: 60 passed; 0 failed; 4 ignored (see local output). No functional regressions.

Rationale
- Aligns with engineering principle: strong typing at the API boundary while preserving current behavior.
- Keeps invalid states unrepresentable for tool names/descriptions; parameters remain a JSON schema `Value` by design.

Risks / Follow-ups
- `request_code_context` param shape in tools/ differs from llm tool schema (search_term/top_k vs token_budget/hint). Current dispatcher expects `token_budget/hint` so we retained the legacy schema. Decide final unification before live tests.
- Deprecation cleanups remain in llm module (warnings about unreachable code in session; unrelated to this change).

Next
- Unify tool parameter shapes across llm <-> dispatcher <-> tools (choose one; migrate others).
- Validate against OpenRouter docs in `crates/ploke-tui/docs/openrouter/request_structure.md`.
- Gate and add live tests (`--features live_api_tests`) once shapes are aligned.
