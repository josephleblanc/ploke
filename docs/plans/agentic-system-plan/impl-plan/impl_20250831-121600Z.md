# Impl Log â€” GAT tools + dispatcher + persistence worker (linked to plan_20250831-121500Z.md)

Summary
- Added GAT impls for two tools:
  - CodeEdit: borrowed params via Cow; returns ApplyCodeEditResult from proposal store; no event emission inside tool.
  - RequestCodeContext: unit-struct GAT tool using Ctx to access RagService; borrowed params; returns snippets + meta.
- Dispatcher:
  - Kept `apply_code_edit` on legacy path.
  - Left `request_code_context` on legacy path for now.
  - Left `get_file_metadata` on legacy path to avoid a `tokio::spawn` Send bound issue that appeared when routing to the GAT path; the GAT impl remains available for future wiring.
- ToolCallParams refactor: now owned `Arc<AppState>`/`Arc<EventBus>` instead of references to simplify spawning and avoid lifetime issues.
- Persistence worker:
  - Added `init_tool_persist_worker` in `observability.rs`: registers a channel via `tools::set_tool_persist_sender`, spawns a consumer, and persists requested+done records.
- Tests:
  - Updated tests to pass owned Arcs to ToolCallParams and clone for reuse.

Results
- Build: ploke-tui crate compiles.
- Tests (ploke-tui): 46 passed; 0 failed in main groups; 2 tests in `observability_lifecycle.rs` fail with Cozo parser error (likely unrelated to this change; DB query path).

Next
- Revisit wiring `get_file_metadata` + `request_code_context` to GAT once the Send-bound is fully validated across spawn.
- Investigate the two observability lifecycle tests; they appear to fail on DB upsert with a Cozo parser error unrelated to the dispatcher/tool changes.
