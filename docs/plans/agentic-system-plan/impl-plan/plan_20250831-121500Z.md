# Plan: Migrate tools to GAT pipeline + persistence worker (2025-08-31)

Objectives and scope
- Migrate tool handling to the new GAT-based pipeline for selected tools while keeping legacy paths working.
- Implement GAT impls for CodeEdit and RequestCodeContext using borrowed params to minimize allocations; keep semantics unchanged.
- Wire dispatcher to use GAT for get_file_metadata and request_code_context; leave apply_code_edit on legacy path for now.
- Add a lightweight mpsc-based persistence worker that consumes ToolCallRecord and persists to ploke-db.
- Keep existing tests green; no behavior changes to user-facing flows.

Proposed steps with rationale and acceptance criteria
1) Add GAT impl for CodeEdit
   - Rationale: Move toward typed, borrowed-params tools; enables centralized completion emission.
   - Accept: Code compiles; unit tests for tool defs still pass; not yet used in dispatcher to avoid double-complete.
2) Add GAT impl for RequestCodeContext
   - Rationale: Align RAG tool with GAT; simplify dispatcher; typed output (snippets + meta).
   - Accept: GAT impl returns structured output using RagService; schema remains identical; compile passes.
3) Wire dispatcher to GAT paths (selective)
   - Rationale: Exercise GAT flow for stable tools now.
   - Accept: rag::dispatcher routes name=="get_file_metadata" → dispatch_tool_gat::<GetFileMetadataTool>(); name=="request_code_context" → dispatch_tool_gat::<RequestCodeContext>(); name=="apply_code_edit" remains legacy.
4) Add mpsc persistence worker
   - Rationale: Capture ToolCallRecord with minimal hot-path overhead; persist requested+done records.
   - Accept: observability initializes a channel via tools::set_tool_persist_sender, spawns worker to upsert requested + done using DB helpers. Best-effort; errors logged.
5) Run tests
   - Rationale: Evidence-based readiness.
   - Accept: All existing tests remain green locally.

Deliverables and validation approach
- Code changes under `crates/ploke-tui/src/tools/` for GAT impls; `crates/ploke-tui/src/rag/dispatcher.rs` for wiring; `crates/ploke-tui/src/observability.rs` for persistence worker.
- Validation: `cargo test -p ploke-tui` and repo root test run. Summarize pass/fail counts. No live network tests unless gated.
- Implementation log `impl_20250831-121600Z.md` linked to this plan will summarize decisions and evidence.

Notes
- We intentionally avoid changing `ToolEvent::Requested` payload shape in this pass to limit surface area. That refactor can follow once downstreams are adapted.
