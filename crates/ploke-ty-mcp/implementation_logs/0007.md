# 0007 – Review: status vs PLAN, readiness, gaps, and path forward

Summary
- Current implementation is on track with PLAN.md through Milestone M2 (partially complete).
- Core pieces exist: McpManager with spawn/cancel/cancel_all, config loader (default path), autostart honoring priority, generic call_tool, typed Git and Context7 clients, tracing spans, and per-server default timeouts.
- Overall readiness: pre-beta for internal consumers; not yet production-ready due to lifecycle resilience, API polish, and tests/docs gaps.

Progress against PLAN.md
- M0 (Scaffolding): Complete — types.rs, manager.rs, config.rs exist; registry and lifecycle scaffold in place.
- M1 (Typed clients + generic call): Substantial — GitClient and Context7Client wrap manager; generic call_tool implemented.
- M2 (Config + autostart + tracing + timeouts): Partially complete — config TOML parsing, autostart by priority, tracing spans, default per-server timeout added; restart policy not yet implemented.
- M3 (Error normalization, outputs, docs/tests): Partial — errors are enumerated but normalization is minimal; ToolResult is text-only; unit tests exist for tool mapping; E2E tests present only in legacy example modules; docs are light.
- M4 (Extended Git API/streaming): Not started — only core Git ops are wrapped; no streaming.
- M5 (Stability: backoff/restart, health checks): Not started — fields exist (restart_on_exit) but no implementation; no health checks/backoff.

Production readiness assessment
- Strengths: Clear abstraction boundary (McpManager + typed clients), timeouts, tracing, config-driven servers, autostart ordering.
- Risks/blocks:
  - Lifecycle resilience: no restart/backoff or health checks; transient failures will bubble up to callers.
  - API surface: duplicate legacy example modules (src/git_client.rs, src/context7_client.rs) coexist with typed clients; confusing public surface.
  - Cancellation/timeout: per-server default only; no per-call overrides and no explicit cancellation token support.
  - Error/typing: ToolResult is free-form text; limited error normalization; integration surfaces will have to string-match.
  - Tests/docs: missing config and manager unit tests for new fields; typed-client E2E tests gated like the examples; docs for config fields (default_timeout_ms, env) not in PLAN.md/README.

Key gaps to close
1) Resilient process lifecycle
   - Honor restart_on_exit with bounded exponential backoff and jitter.
   - Health checks: post-spawn list_tools with short timeout; optional periodic pings.
   - Pre-flight checks for required binaries (e.g., uvx, npx) and clear errors.
2) Cancellation and per-call timeouts
   - Add call_tool_with_timeout(id, tool, args, Duration).
   - Optional CancellationToken parameter for cooperative cancellation (tokio-util).
3) API surface cleanup
   - Move legacy example modules (src/git_client.rs, src/context7_client.rs) into examples/ or hide behind a feature; keep src/clients/* as the canonical API.
4) Error normalization and structured outputs
   - Normalize common MCP tool errors (transport vs tool vs invalid args).
   - Consider ToolResult variants (Text, Json(Value), Blocks) to avoid lossy text concatenation.
5) Tests and documentation
   - Unit tests: config parsing (default_timeout_ms), autostart ordering and timeouts.
   - E2E tests for typed clients, gated by PLOKE_E2E_MCP=1.
   - User docs: sample mcp.toml, env handling, timeouts, autostart, troubleshooting.
6) Observability polish
   - Add span fields for timing and result sizes consistently; warn on large payloads.
   - Document using util::init_tracing_once in examples/tests.
7) Security/ops
   - Optional allowlist for server commands; warn on non-standard binaries; document installation expectations.

Highest impact next feature
- Implement resilient lifecycle: restart_on_exit with exponential backoff + health checks (+ pre-flight checks).
  - Rationale: Stabilizes all higher-level workflows (tui/agent flows), reduces flaky failures, and unlocks reliable autostart for daily usage.

Recommended path forward (incremental)
1) Lifecycle resilience (M5 subset)
   - Implement restart_on_exit with backoff and jitter.
   - Add health_check() using list_tools with a small timeout; call after spawn and optionally on a timer (opt-in).
   - Add pre-flight checks for command existence; produce actionable McpError::Spawn diagnostics.
2) Cancellation/timeout ergonomics (M2.5)
   - Add call_tool_with_timeout and, optionally, call_tool_with_cancel using a CancellationToken parameter.
   - Thread timeout into tracing spans and errors.
3) API surface cleanup
   - Move src/git_client.rs and src/context7_client.rs into examples/; remove from lib exports to avoid confusion.
4) Tests and docs
   - Unit tests for config (default_timeout_ms), autostart order, lifecycle restart/backoff paths (injectable spawner).
   - E2E: minimal happy-path for GitClient and Context7Client (skipped by default).
   - Docs: update PLAN.md and README with default_timeout_ms, lifecycle behavior, and examples setup.
5) Optional next
   - Structured ToolResult types; add per-tool adapters in typed clients when stable schemas are available.

Suggested PLAN.md edits
- Config Design: document default_timeout_ms on servers and its default behavior.
- Milestones: call out lifecycle resilience (restart_on_exit + backoff + health checks) as part of M2/M5 with concrete acceptance criteria.
- Observability: mention util::init_tracing_once for tests/examples and expected tracing fields (server_id, tool, durations, sizes).

Notes
- The foundation is solid; closing lifecycle and API ergonomics gaps will move the crate to a credible beta for internal production use.
