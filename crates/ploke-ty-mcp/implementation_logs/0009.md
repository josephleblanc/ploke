# 0009 â€“ Restart-on-exit (on-demand), backoff on spawn, and resilient list_tools/call paths

Decisions
- Implement bounded exponential backoff + jitter during initial spawn and health check.
- Add on-demand restart-on-exit semantics: if a tool call or list_tools fails and the server is configured with restart_on_exit = true, attempt one respawn and retry within the original timeout budget.
- Keep registry type simple (ServerId -> RunningService) to avoid broader refactors; supervision is cooperative via call sites rather than a background task.

Changes Summary
- manager.rs:
  - ensure_started now uses spawn_with_backoff(..) which wraps spawn + health_check with retries and jitter.
  - do_call_tool now supports a single respawn-and-retry attempt when restart_on_exit is enabled, preserving the overall timeout budget.
  - list_tools similarly retries once with respawn under restart_on_exit.
  - Added respawn_with_backoff(..) and spawn_with_backoff(..) helpers.
  - Minor import: rand for jitter; extra tracing on retries and backoff waits.
- Cargo.toml:
  - Added dependency rand = "0.8".

Rationale
- Backoff smooths transient spawn/connect flakiness (e.g., slow npm/uvx cold starts).
- On-demand restart provides practical resilience without introducing a background supervisor yet, minimizing churn and scope.

Next Steps
- Supervisor task (optional): background health ping + automatic restart to catch idle crashes proactively.
- Cancellation tokens: optional tokio-util::CancellationToken for cooperative cancellation of long tool calls.
- Examples relocation: move src/git_client.rs and src/context7_client.rs into examples/ or behind a feature to complete API surface cleanup.
- Tests: unit tests for backoff paths (inject spawn failure), retry logic honoring timeouts, and config restart_on_exit toggles.

Suggested PLAN.md Edits
- Document restart_on_exit behavior as "on-demand respawn with one retry per call" for v0; consider background supervision as M5 enhancement.
- Note that initial startup uses bounded backoff with jitter and an upfront health check (list_tools).
