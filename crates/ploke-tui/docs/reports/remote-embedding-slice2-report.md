# Remote Embedding — Slice 2 Report (2025-11-18)

## Summary
- Dual-write helpers and HNSW index/search paths in `ploke-db` are now multi-embedding aware under `multi_embedding_db`, while legacy single-column embeddings remain supported when the feature is disabled.
- Slice 2 telemetry is captured in `target/test-output/embedding/slice2-db.json`, generated via `cargo xtask embedding:collect-evidence --slice 2`, and records Validation Matrix commands for schema/db/runtime tiers.
- TUI runtime tests now execute under `multi_embedding_runtime` (via the `load_db_crate_focus` integration test), providing a basic sanity check that DB-backed flows compile and run with the runtime flag enabled.

## Feature flag state for this slice
- Compile-time:
  - `ploke-db`: `multi_embedding_schema`, `multi_embedding_db` (plus the alias `multi_embedding_experiment` → `multi_embedding_schema`).
  - `ploke-tui`: `multi_embedding_schema`, `multi_embedding_db`, `multi_embedding_runtime` (used for the runtime-tier test command in the Validation Matrix).
- Runtime:
  - Dual-write behavior is enabled via `MultiEmbeddingRuntimeConfig::enable_multi_embedding_db`, gated by the `PLOKE_MULTI_EMBEDDING_DB` env knob.
  - Runtime-owned embedding relations and HNSW indexes are exercised only in tests; Slice 3 will wire runtime writers/readers.

## Evidence collected
| Artifact | Generated by | Notes |
| --- | --- | --- |
| `target/test-output/embedding/slice2-db.json` | `cargo xtask embedding:collect-evidence --slice 2` | Captures schema/db/runtime Validation Matrix entries and test summaries for `ploke-db`, `ploke-test-utils`, and `ploke-tui` under the multi-embedding flags. |

### Validation Matrix commands (offline)
- `cargo test -p ploke-db --features multi_embedding_schema`
- `cargo test -p ploke-test-utils --features multi_embedding_schema` *(currently compiles but runs zero tests under this flag; recorded in `flag_validation.note`).*
- `cargo test -p ploke-db --features multi_embedding_db`
- `cargo test -p ploke-test-utils --features multi_embedding_db` *(currently compiles but runs zero tests under this flag; recorded in `flag_validation.note`).*
- `cargo test -p ploke-tui --features multi_embedding_runtime --test load_db_crate_focus`

## Notable verifications
- **Dual-write helpers (`ploke-db`)**
  - `update_embeddings_dual_writes_metadata_and_vectors` verifies that `update_embeddings_batch` writes both metadata tuples and `<F32; dims>` vector rows using `dimension_spec_for_length` and `ExperimentalVectorRelation::upsert_vector_values`.
  - `get_unembedded_respects_runtime_embeddings` confirms that pending-embedding counts and `get_unembedded_node_data` skip nodes that already have runtime-owned embeddings once the legacy column is cleared.
- **HNSW multi-embedding behavior (`ploke-db`)**
  - `multi_embedding_hnsw_index_and_search` ensures `hnsw_of_type` fans out across per-dimension vector relations, builds `:vector_idx` structures via the adapter, and successfully returns a runtime-seeded vector.
- **TUI/runtime sanity**
  - `load_db_crate_focus` continues to validate `crate_focus` scoping and now runs under `multi_embedding_runtime` as part of the Slice 2 Validation Matrix, ensuring the runtime flag does not break basic DB-backed flows.

## Outstanding work / forward-looking notes
1. `ploke-test-utils` currently has zero tests under `multi_embedding_schema`/`multi_embedding_db`; future passes should add fixture-level coverage and remove the `flag_validation` notes once tests exist.
2. TUI tests still focus on path scoping and crate focus; dedicated multi-embedding runtime tests for backup/restore and `scan_for_change` remain a target for Slice 3.
3. Live telemetry for Slice 2 is intentionally omitted; if future work runs DB helpers against remote providers, the resulting `slice2-db-live-<timestamp>.json` artifacts should be linked here alongside offline evidence.

