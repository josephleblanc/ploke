# Remote Embedding — Slice 2 Report (2025-11-18)

## Summary
- Dual-write helpers and HNSW index/search paths in `ploke-db` are now multi-embedding aware under `multi_embedding_db`, while legacy single-column embeddings remain supported when the feature is disabled.
- Slice 2 telemetry is captured in `target/test-output/embedding/slice2-db.json`, generated via `cargo xtask embedding:collect-evidence --slice 2`, and records Validation Matrix commands for schema/db/runtime tiers.
- TUI runtime tests now execute under `multi_embedding_runtime` (via the `load_db_crate_focus` integration test and new `multi_embedding_runtime_db_tests.rs`), providing initial coverage of DB-backed flows with multi-embedding fixtures. The runtime tier note in `slice2-db.json` remains the source of truth for current coverage limits.

## Feature flag state for this slice
- Compile-time:
  - `ploke-db`: `multi_embedding_schema`, `multi_embedding_db` (plus the alias `multi_embedding_experiment` → `multi_embedding_schema`).
  - `ploke-tui`: `multi_embedding_schema`, `multi_embedding_db`, `multi_embedding_runtime` (used for the runtime-tier test command in the Validation Matrix).
- Runtime:
  - Dual-write behavior is enabled via `MultiEmbeddingRuntimeConfig::enable_multi_embedding_db`, gated by the `PLOKE_MULTI_EMBEDDING_DB` env knob.
  - Runtime-owned embedding relations and HNSW indexes are exercised only in tests; Slice 3 will wire runtime writers/readers.

## Evidence collected
| Artifact | Generated by | Notes |
| --- | --- | --- |
| `target/test-output/embedding/slice2-db.json` | `cargo xtask embedding:collect-evidence --slice 2` | Captures schema/db/runtime Validation Matrix entries and test summaries for `ploke-db`, `ploke-test-utils`, and `ploke-tui` under the multi-embedding flags. All tiers now show passing tests. |

### Validation Matrix commands (offline)
- `cargo test -p ploke-db --features multi_embedding_schema` ✅
- `cargo test -p ploke-test-utils --features multi_embedding_schema` ✅ (tests: `seeds_multi_embedding_relations_for_fixture_nodes`, `setup_db_full_embeddings_returns_embedding_batches`, `seed_multi_embedding_schema_creates_all_node_type_relations`)
- `cargo test -p ploke-db --features multi_embedding_db` ✅
- `cargo test -p ploke-test-utils --features multi_embedding_db` ✅ (tests: `dual_write_reduces_pending_embeddings_with_fixtures`, `get_unembedded_respects_runtime_embeddings_in_test_utils`)
- `cargo test -p ploke-tui --features multi_embedding_runtime --test load_db_crate_focus` ✅

### Additional runtime tests
- `cargo test -p ploke-tui --features multi_embedding_runtime --test multi_embedding_runtime_db_tests` ✅ (tests: `load_db_with_multi_embedding_fixture`, `scan_for_change_with_multi_embedding_relations`)

## Notable verifications
- **Dual-write helpers (`ploke-db`)**
  - `update_embeddings_dual_writes_metadata_and_vectors` verifies that `update_embeddings_batch` writes both metadata tuples and `<F32; dims>` vector rows using `dimension_spec_for_length` and `ExperimentalVectorRelation::upsert_vector_values`.
  - `get_unembedded_respects_runtime_embeddings` confirms that pending-embedding counts and `get_unembedded_node_data` skip nodes that already have runtime-owned embeddings once the legacy column is cleared.
  - `count_pending_embeddings_parity_legacy_vs_multi` validates that pending counts match between legacy and multi-embedding paths when no runtime embeddings exist, and that multi-embedding counts decrease correctly after embedding.
- **HNSW multi-embedding behavior (`ploke-db`)**
  - `multi_embedding_hnsw_index_and_search` ensures `hnsw_of_type` fans out across per-dimension vector relations, builds `:vector_idx` structures via the adapter, and successfully returns a runtime-seeded vector.
- **TUI/runtime sanity**
  - `load_db_crate_focus` continues to validate `crate_focus` scoping and now runs under `multi_embedding_runtime` as part of the Slice 2 Validation Matrix, ensuring the runtime flag does not break basic DB-backed flows.
  - `load_db_with_multi_embedding_fixture` validates that multi-embedding fixture backups can be loaded and that all expected metadata relations exist after import.
  - `scan_for_change_with_multi_embedding_relations` verifies that `scan_for_change` flows remain compatible when runtime-owned embedding relations are present.
- **Test-utils coverage**
  - `seed_multi_embedding_schema_creates_all_node_type_relations` ensures seeding creates metadata relations for all node types.
  - `dual_write_reduces_pending_embeddings_with_fixtures` validates that dual-write behavior correctly updates pending counts.
  - `get_unembedded_respects_runtime_embeddings_in_test_utils` confirms that nodes with runtime embeddings are excluded from unembedded lists.

## Outstanding work / forward-looking notes
1. ✅ **Completed**: `ploke-test-utils` now has comprehensive tests under `multi_embedding_schema` and `multi_embedding_db` covering schema seeding, dual-write behavior, and runtime-aware pending counts.
2. ✅ **Completed**: TUI runtime tests (`multi_embedding_runtime_db_tests.rs`) now exercise `load_db` with multi-embedding fixtures and verify `scan_for_change` compatibility with runtime-owned relations.
3. Live telemetry for Slice 2 is intentionally omitted; if future work runs DB helpers against remote providers, the resulting `slice2-db-live-<timestamp>.json` artifacts should be linked here alongside offline evidence.
4. **Slice 3 preparation**: The test infrastructure is now in place for Slice 3 indexer/CLI integration work. Tests validate that multi-embedding relations persist through backup/restore cycles and that runtime-aware helpers correctly filter nodes with existing embeddings.
