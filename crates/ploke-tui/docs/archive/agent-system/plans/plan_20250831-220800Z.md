Plan: Tool System E2E Validation (DB↔Tools↔OpenRouter)

Objectives & Scope
- Diagnose and fix the DB canonical resolver used by tools; document the root cause and guardrails.
- Update the inter-crate contract (ploke-tui ↔ ploke-db) with invariants and failure semantics.
- Validate the tool system end-to-end offline (fixture DB) and live (OpenRouter) with typed requests and responses.
- Capture evidence artifacts (requests, responses, logs); apply live-gate discipline (don’t claim green without tool_calls observed).
- Establish initial benchmarks for resolver and critical paths.

Proposed Steps (with rationale & acceptance)
1) Diagnose helper failure (artifact-driven)
   - Rationale: Reproduce, isolate, and observe missing rows; compare with id-anchored path.
   - Actions: Expand helper-vs-id test; log per-relation results, module path, file path, NOW usage.
   - Acceptance: Artifact clearly shows why 0 rows occurred; nested modules/file_mod ownership clarified.

2) Fix & document canonical resolvers
   - Rationale: Make strict path robust for nested modules; add relaxed fallback (module-only).
   - Actions: Implement file_owner_for_module (self-or-ancestor with file_mod); add relaxed resolver; unit tests.
   - Acceptance: Strict passes for known cases; relaxed succeeds when strict fails; docs updated with rule sketch + examples.

3) Update tool↔DB contract
   - Rationale: Prevent silent coupling drift and make failure modes explicit.
   - Actions: Specify inputs/outputs/invariants; document 0/1/>1 behaviors; link to notes.
   - Acceptance: Contract reflects strict and relaxed flows; examples for main node types.

4) Integrate strict→fallback in tool system
   - Rationale: Real users pass relative or absolute paths; we must be resilient.
   - Actions: Route canonical lookups strict→fallback; normalize file paths; emit actionable errors.
   - Acceptance: Offline e2e passes; ambiguity and 0-match cases contain candidate file diagnostics.

5) Offline E2E (fixture DB)
   - Rationale: Validate the full tool-edit staging without network.
   - Actions: Use TEST_APP; stage canonical edit; preview; approve; verify delta.
   - Acceptance: Test passes; preview present; file delta applied and restored.

6) Live API E2E (OpenRouter)
   - Rationale: Exercise real endpoints with tools; verify request/response shapes and loop.
   - Actions: Build OpenAI-style request with tools; query `/models/:author/:slug/endpoints`; select tool-capable provider; set `tool_choice` as function; dispatch chat/completions.
   - Acceptance: Status OK; tool_calls present OR logged as not validated (no_tool_calls.txt). Store request/response under `ai_temp_data/live/`.

7) Docs & Test Review
   - Rationale: Create durable knowledge; identify gaps.
   - Actions: Update canonical notes; update tool contract; write status report (evidence, gaps, next steps).
   - Acceptance: Linked docs; concise pass/fail counts; clear next steps.

8) Benchmarks & Profiling
   - Rationale: Establish baselines for critical operations.
   - Actions: Criterion bench for resolver strict path (fixture DB); plan further benches for end-to-end.
   - Acceptance: Bench runs or no-ops gracefully if backup missing; preliminary numbers recorded.

Deliverables & Validation Approach
- Evidence artifacts:
  - DB helper: `crates/ploke-db/tests/ai_temp_data/test-output.txt`
  - Live: `crates/ploke-tui/ai_temp_data/live/{request.json,response.json,no_tool_calls.txt?}`
- Docs:
  - Canonical notes: `docs/design/queries/canonical_resolution_notes.md`
  - Contract: `crates/ploke-tui/docs/crate-contracts/tool-to-ploke-db.md`
  - Status report: `docs/reports/tool_resolver_status_*.md`
- Live gate: Only count live tests as validated when `tool_calls` observed and the tool loop (request→tool→tool_output→API) is exercised; otherwise mark “Not Validated”.
- Benchmarks: Record version, environment, and input data (fixture DB) alongside numbers.

References
- AGENTS.md, AGENT_SYSTEM_PLAN.md
- Workflow doc: `crates/ploke-tui/docs/feature/agent-system/workflows/tool_use_end_to_end.md`
- Related plan: `crates/ploke-tui/docs/feature/agent-system/plans/tool-e2e.md`
