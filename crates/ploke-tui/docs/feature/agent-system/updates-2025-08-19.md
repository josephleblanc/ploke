# Plan updates — 2025-08-19

Scope
- Incorporate Cozo v0.7 Validity/Json semantics into M0/M1 plans and ploke-db contract.
- Record resolved decisions from USER feedback.
- Provide per-milestone context file lists to keep implementation focused.

Cozo modeling updates (normative)
- Time-travel: Make tool_call and conversation_turn relations time-travel-enabled by using at: Validity as the last key part. Represent lifecycle with new asserted rows; do not mutate in place.
- Json: Prefer cozo Json columns for arguments_json/outcome_json when enabled. Default to redaction by storing only args_sha256.
- Paths: Persist project-relative paths; keep absolute-path enforcement in ploke-io.
- Timestamps: Use 'ASSERT'/'RETRACT' in puts and '@ NOW' in reads to ensure consistent transaction timestamps.

Decision summaries
- Chat history: Persist to DB (primary). File export is optional and deferred.
- Typed tool events: Add in M0 with a compatibility bridge; remove legacy path in M1.
- EventBus capacities: keep current defaults; instrument lag.
- Log retention: daily rotation, keep 7 days.

Milestone 0 — context focus (TUI)
- crates/ploke-tui/src/event_bus/mod.rs (run_event_bus; sole forwarder for IndexingStatus → AppEvent)
- crates/ploke-tui/src/app_state/handlers/indexing.rs (stop emitting IndexingCompleted/Failed directly)
- crates/ploke-tui/src/app/events.rs (consumer of AppEvent; ensure no duplicate completions)
- crates/ploke-tui/src/llm/tool_call.rs, src/llm/session.rs, src/llm/mod.rs (tool-call dispatch/await; bridge typed events in M0)
- crates/ploke-tui/src/file_man.rs (save_content: leave as export path; primary persistence is DB)
- crates/ploke-tui/src/error.rs, src/tracing_setup.rs (telemetry events)
- Docs: this file; milestones/m0_context_files.md; ploke_db_contract.md

Milestone 1 — context focus (editing HIL)
- crates/ploke-tui/src/app_state/commands.rs (add ApproveEdits/DenyEdits)
- crates/ploke-tui/src/app_state/dispatcher.rs (route new commands)
- crates/ploke-tui/src/app_state/handlers/rag.rs (apply_code_edit approval gate + diff preview)
- crates/ploke-tui/src/app/commands/parser.rs and exec.rs (parse 'edit approve/deny <request_id>')
- crates/ploke-tui/src/llm/mod.rs (tool schema already defined; keep)
- Docs: milestones/m1_context_files.md; ploke_db_requests.md

Status
- Ready to proceed with M0 implementation as updated. No blockers beyond the “New questions” in decisions_required.md.
